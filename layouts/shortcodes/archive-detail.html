{{ $lang := .Page.Lang | default "de" }}

<div class="archive-detail-wrapper" data-lang="{{ $lang }}">
  <h2 id="detailTitle"></h2>
  <nav aria-label="breadcrumb">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="/{{ $lang }}/" id="breadcrumbHome"></a></li>
      <li class="breadcrumb-item"><a href="/{{ $lang }}/archiv/" id="breadcrumbArchive"></a></li>
      <li class="breadcrumb-item active" aria-current="page" id="detailBreadcrumb"></li>
    </ol>
  </nav>
  <hr class="hr hr-blurry">

  <div class="row">
    <div class="col-md-3 text-nowrap">
      <strong id="labelDate"></strong>
    </div>
    <div class="col-md-9" id="detailDate"></div>
  </div>
  <div class="row">
    <div class="col-md-3 text-nowrap">
      <strong id="labelDuration"></strong>
    </div>
    <div class="col-md-9" id="detailDuration"></div>
  </div>
  <div class="row">
    <div class="col-md-3 text-nowrap">
      <strong id="labelLocation"></strong>
    </div>
    <div class="col-md-9" id="detailLocation"></div>
  </div>
  <div class="row">
    <div class="col-md-3 text-nowrap">
      <strong id="labelBand"></strong>
    </div>
    <div class="col-md-9" id="detailBand"></div>
  </div>
  <div class="row">
    <div class="col-md-3 text-nowrap">
      <strong id="labelFrequency"></strong>
    </div>
    <div class="col-md-9" id="detailFrequency"></div>
  </div>
  <div class="row">
    <div class="col-md-3 text-nowrap">
      <strong id="labelBandwidth"></strong>
    </div>
    <div class="col-md-9" id="detailBandwidth"></div>
  </div>
  <div class="row">
    <div class="col-md-3 text-nowrap">
      <strong id="labelDevice"></strong>
    </div>
    <div class="col-md-9" id="detailDevice"></div>
  </div>
  <div class="row">
    <div class="col-md-3 text-nowrap">
      <strong id="labelAntenna"></strong>
    </div>
    <div class="col-md-9" id="detailAntenna"></div>
  </div>
  <div class="row">
    <div class="col-md-3 text-nowrap">
      <strong id="labelCenterFrequency"></strong>
    </div>
    <div class="col-md-9" id="detailCenterFrequency"></div>
  </div>
  <div class="row">
    <div class="col-md-3 text-nowrap">
      <strong id="labelEncoding"></strong>
    </div>
    <div class="col-md-9" id="detailEncoding"></div>
  </div>
  <div class="row">
    <div class="col-md-3 text-nowrap">
      <strong id="labelFilters"></strong>
    </div>
    <div class="col-md-9" id="detailFilters"></div>
  </div>
  <div class="row">
    <div class="col-md-3 text-nowrap">
      <strong id="labelPreAmp"></strong>
    </div>
    <div class="col-md-9" id="detailPreAmp"></div>
  </div>
  <div class="row">
    <div class="col-md-3 text-nowrap">
      <strong id="labelRemarks"></strong>
    </div>
    <div class="col-md-9" id="detailRemarks"></div>
  </div>
  <div class="row">
    <div class="col-md-3">
      <strong id="labelUploadedBy"></strong>
    </div>
    <div class="col-md-9">
      Walter Barteczek
    </div>
  </div>
  <div class="row">
    <div class="col-md-3">
      <strong id="labelLicense"></strong>
    </div>
    <div class="col-md-9">
      <a href="https://opendatacommons.org/licenses/odbl/" rel="nofollow" target="_blank">Open Data Commons Open Database License (ODbL)</a>
    </div>
  </div>
  <p>&nbsp;</p>
  <div class="row">
    <div class="col-md-3">
      <strong id="labelDownload"></strong>
    </div>
    <div class="col-md-9">
      <a href="" target="_blank" class="btn btn-secondary" id="downloadLink"></a>
    </div>
  </div>

  <h2 id="labelStationsTitle"></h2>

  <table id="stationTable" class="table table-striped table-hover">
    <thead>
      <tr>
        <th id="labelFrequencyCol"></th>
        <th id="labelSNRCol"></th>
        <th id="labelCountryCol"></th>
        <th id="labelProgrammeCol"></th>
        <th id="labelTXSiteCol"></th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script>
  (function() {
    const wrapper = document.querySelector('.archive-detail-wrapper');
    if (!wrapper) return;

    const lang = wrapper.dataset.lang || "de";

    // Translations
    const i18n = {
      de: {
        home: "Home",
        archive: "Aufnahmen",
        recordingDate: "Aufnahme Datum",
        duration: "Dauer",
        durationSeconds: "Sekunden",
        location: "Aufnahme Ort",
        band: "Band",
        frequencyRange: "Frequenzbereich",
        bandwidth: "Bandbreite",
        device: "Aufnahmegerät",
        antenna: "Antenne",
        centerFrequency: "Bandmittenfrequenz",
        encoding: "Encoding",
        filters: "Filter",
        preAmp: "Vorverstärker",
        remarks: "Bemerkungen",
        uploadedBy: "Hochgeladen von",
        license: "License",
        download: "Download",
        downloadLabel: "Download (RFCorder, SDRUnoSDR#)",
        stations: "Radiostationen",
        frequency: "Frequency",
        snr: "SNR",
        country: "Country",
        programme: "Programme",
        txSite: "TX Site",
        noStations: "Keine Radiostationen in dieser Aufnahme gefunden.",
        redirectUrl: "/de/archiv"
      },
      en: {
        home: "Home",
        archive: "Recordings",
        recordingDate: "Recording Date",
        duration: "Duration",
        durationSeconds: "seconds",
        location: "Recording Location",
        band: "Band",
        frequencyRange: "Frequency Range",
        bandwidth: "Bandwidth",
        device: "Recording Device",
        antenna: "Antenna",
        centerFrequency: "Center Frequency",
        encoding: "Encoding",
        filters: "Filters",
        preAmp: "Pre-Amplifier",
        remarks: "Remarks",
        uploadedBy: "Uploaded by",
        license: "License",
        download: "Download",
        downloadLabel: "Download (RFCorder, SDRUnoSDR#)",
        stations: "Radio Stations",
        frequency: "Frequency",
        snr: "SNR",
        country: "Country",
        programme: "Programme",
        txSite: "TX Site",
        noStations: "No radio stations found in this recording.",
        redirectUrl: "/en/archiv"
      }
    };

    const t = i18n[lang] || i18n.de;

    document.addEventListener("DOMContentLoaded", async function () {
      // Set labels
      document.getElementById("breadcrumbHome").textContent = t.home;
      document.getElementById("breadcrumbArchive").textContent = t.archive;
      document.getElementById("labelDate").textContent = t.recordingDate;
      document.getElementById("labelDuration").textContent = t.duration;
      document.getElementById("labelLocation").textContent = t.location;
      document.getElementById("labelBand").textContent = t.band;
      document.getElementById("labelFrequency").textContent = t.frequencyRange;
      document.getElementById("labelBandwidth").textContent = t.bandwidth;
      document.getElementById("labelDevice").textContent = t.device;
      document.getElementById("labelAntenna").textContent = t.antenna;
      document.getElementById("labelCenterFrequency").textContent = t.centerFrequency;
      document.getElementById("labelEncoding").textContent = t.encoding;
      document.getElementById("labelFilters").textContent = t.filters;
      document.getElementById("labelPreAmp").textContent = t.preAmp;
      document.getElementById("labelRemarks").textContent = t.remarks;
      document.getElementById("labelUploadedBy").textContent = t.uploadedBy;
      document.getElementById("labelLicense").textContent = t.license;
      document.getElementById("labelDownload").textContent = t.download;
      document.getElementById("downloadLink").textContent = t.downloadLabel;
      document.getElementById("labelStationsTitle").textContent = t.stations;
      document.getElementById("labelFrequencyCol").textContent = t.frequency;
      document.getElementById("labelSNRCol").textContent = t.snr;
      document.getElementById("labelCountryCol").textContent = t.country;
      document.getElementById("labelProgrammeCol").textContent = t.programme;
      document.getElementById("labelTXSiteCol").textContent = t.txSite;

      try {
        const params = new URLSearchParams(window.location.search);
        const id = params.get('id');

        const response = await fetch(`https://cohiradia.radiomuseum.org/api/metadata/${id}`);
        const data = await response.json();

        document.getElementById("downloadLink").href = `https://cohiradia.radiomuseum.org/view/recordings/${id}`;

        // Helper function to set element text content
        const setField = (id, value) => {
          const el = document.getElementById(id);
          if (el) el.textContent = value || '-';
        };

        // Populate detail fields
        const fields = {
          'detailTitle': data.content,
          'detailBreadcrumb': data.content,
          'detailDate': data["recording-date"],
          'detailDuration': `${data["duration"]} ${t.durationSeconds}`,
          'detailLocation': `${data["location-country"] || ''}, ${data["location-city"] || ''}`.replace(/^,\s*|,\s*$/g, ''),
          'detailBand': data["band"],
          'detailFrequency': `${data["frequency-low"]} ${data["frequency-unit"]} - ${data["frequency-high"]} ${data["frequency-unit"]}`,
          'detailBandwidth': `${data["bandwidth"]} ${data["frequency-unit"]}`,
          'detailDevice': data["recording-type"],
          'detailAntenna': data["antenna"],
          'detailCenterFrequency': `${data["center-frequency"]} ${data["frequency-unit"]}`,
          'detailEncoding': data["encoding"],
          'detailFilters': data["filters"],
          'detailPreAmp': data["preamp-settings"],
          'detailRemarks': data["remark"]
        };

        Object.entries(fields).forEach(([id, value]) => setField(id, value));

        if(!data["radio-stations"] || data["radio-stations"].length === 0) {
          document.getElementById("stationTable").outerHTML = `<p class="text-muted">${t.noStations}</p>`;
          return;
        }
        
        const table = document.getElementById("stationTable");
        if (!table) return;

        const tbody = table.querySelector("tbody");
        data["radio-stations"].forEach(item => {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${item.frequency} kHz</td>
            <td>${item.snr || '-'}</td>
            <td>${item["country"] || '-'}</td>
            <td>${item["programme"] || '-'}</td>
            <td>${item["tx-site"] || '-'}</td>
          `;
          tbody.appendChild(row);
        });
      } catch (error) {
        console.error("Could not load data:", error);
        window.location.href = t.redirectUrl;
      }
    });
  })();
</script>
